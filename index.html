<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Hashiconf-napa-2016 by vynjo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Hashiconf-napa-2016</h1>
      <h2 class="project-tagline">HashiConf EU 2016 with Telemetry</h2>
      <a href="https://github.com/vynjo/hashiconf-napa-2016" class="btn">View on GitHub</a>
      <a href="https://github.com/vynjo/hashiconf-napa-2016/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/vynjo/hashiconf-napa-2016/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="this-is-basis-of-the-demo-that-circonus-was-using-at-hashiconf-napa-2016" class="anchor" href="#this-is-basis-of-the-demo-that-circonus-was-using-at-hashiconf-napa-2016" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>This is basis of the demo that Circonus was using at HashiConf NAPA 2016.</h1>

<p>It is based based on kelseyhightower's awesome [Hashconf EU 2016 presentation] (https://github.com/kelseyhightower/hashiconf-eu-2016).
Well, more than based on, a minor update to include telemetry data for each of the components (Consul, Nomad, Vault, as well as Fabio).</p>

<p>Completely awesome example showing the power of Hashicorp's products, with a little bit of Circonus magic thrown in.</p>

<p>So, if you follow the instructions below, you'll end up with a deployment that looks something like this:</p>

<p><img src="http://www.vynjo.com/files/hashistack/hashistack_diagram.png" alt=""></p>

<h1>
<a id="overview" class="anchor" href="#overview" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Overview</h1>

<p>Once you have completed the setup, you will have:</p>

<ul>
<li>a 3 node server cluster (ns-1, ns-2, ns-3) running Consul, Nomad, and Vault servers. Each member of the cluster will AUTOMATICALLY create a corresponding set of Circonus metrics for each of the servers (Consul, Nomad, and Vault). These metrics will include the all important latency metrics (represented via histograms in Circonus), as well as basic information on CPU, Memory, and Disk utilization</li>
<li>5 client machines with Nomad configured in agent mode, and, again, each of these machines will AUTOMATICALLY create a set of Circonus metrics with similar information as that of the Servers. </li>
<li>A MySQL instance (to store the VAULT secrets)</li>
<li>A load balancer (to give you one public IP)</li>
</ul>

<p>Now that you have the basic infrastructure, you'll then launch two nomad jobs</p>

<ul>
<li>Consul in agent mode</li>
<li>Fabio, a sophisticated software load balancer</li>
</ul>

<p>These nomad jobs are configured to run a single allocation on each of the 5 clients, and each will produce a corresponding set of Circonus metrics</p>

<p>Finally, you will launch a simple application called 'hashiapp' via one of the server cluster machines (ns-1), and you can experiment with starting and stopping an application, adjusting the allocation count (there are versions with 3, and 10 allocationssd) and again, viewing the</p>

<h2>
<a id="prerequisites" class="anchor" href="#prerequisites" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Prerequisites</h2>

<p><a href="hashistack.md">Bootstrap the HashiStack on Google Compute Engine</a>
[Once this is done you'll see your metrics flowing into your Circonus account.]</p>

<p>Login into the controller node and checkout this repository.</p>

<pre><code>gcloud compute ssh ns-1
</code></pre>

<pre><code>git clone https://github.com/vynjo/hashiconf-napa-2016
</code></pre>

<pre><code>cd hashiconf-napa-2016
</code></pre>

<h3>
<a id="create-the-hashiapp-policy-and-token" class="anchor" href="#create-the-hashiapp-policy-and-token" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Create the Hashiapp Policy and Token</h3>

<pre><code>export VAULT_ADDR=http://ns-1:8200
</code></pre>

<pre><code>vault policy-write hashiapp vault/hashiapp-policy.hcl
</code></pre>

<pre><code>vault token-create \
  -policy="hashiapp" \
  -display-name="hashiapp"
</code></pre>

<p>Edit <code>jobs/hashiapp.nomad</code> job with TOKEN AND MYSQL address</p>

<pre><code>env {
  VAULT_TOKEN = "HASHIAPP_TOKEN"
  VAULT_ADDR = "http://vault.service.consul:8200"
  HASHIAPP_DB_HOST = "CLOUD_SQL:3306"
}
</code></pre>

<h3>
<a id="create-the-hashiapp-secret" class="anchor" href="#create-the-hashiapp-secret" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Create the Hashiapp Secret</h3>

<pre><code>vault read mysql/creds/hashiapp
</code></pre>

<pre><code>vault write secret/hashiapp jwtsecret=secret
</code></pre>

<h2>
<a id="service-discovery-with-consul" class="anchor" href="#service-discovery-with-consul" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Service Discovery with Consul</h2>

<pre><code>nomad plan jobs/consul.nomad
</code></pre>

<pre><code>nomad run jobs/consul.nomad
</code></pre>

<pre><code>nomad status consul
</code></pre>

<pre><code>consul join nc-1 nc-2 nc-3 nc-4 nc-5
</code></pre>

<pre><code>consul members
</code></pre>

<h2>
<a id="start-load-balancing-with-fabio" class="anchor" href="#start-load-balancing-with-fabio" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Start Load Balancing with Fabio</h2>

<p>Edit the jobs/fabio.nomad file and replace CIRCONUS_API_TOKEN with your Circonus api token</p>

<pre><code>nomad run jobs/fabio.nomad
</code></pre>

<pre><code>nomad status fabio
</code></pre>

<h2>
<a id="hashiapp-job" class="anchor" href="#hashiapp-job" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Hashiapp Job</h2>

<p>Submit the hashiapp service job.</p>

<pre><code>nomad run jobs/hashiapp-v1-c3.nomad
</code></pre>

<pre><code>nomad status hashiapp
</code></pre>

<h4>
<a id="viewing-logs" class="anchor" href="#viewing-logs" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Viewing Logs</h4>

<pre><code>nomad fs -job hashiapp alloc/logs/hashiapp.stderr.0
nomad fs -job hashiapp alloc/logs/hashiapp.stdout.0
</code></pre>

<h4>
<a id="send-traffic" class="anchor" href="#send-traffic" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Send Traffic</h4>

<pre><code>curl -H "Host: hashiapp.com" http://&lt;loadbalancer-ip&gt;:9999/version
</code></pre>

<p>or</p>

<pre><code>while true; do curl -H "Host: hashiapp.com" http://&lt;loadbalancer-ip&gt;:9999/version; sleep 1; done
</code></pre>

<h3>
<a id="scaling-up" class="anchor" href="#scaling-up" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Scaling Up</h3>

<p>Run the <code>jobs/nomad run jobs/hashiapp-v1-c10.nomad</code> which starts 10 allocations instead of 3</p>

<pre><code>nomad run jobs/hashiapp-v1-c10.nomad

</code></pre>

<p>Then you can switch to v2 by running</p>

<pre><code>nomad run jobs/hashiapp-v2-c10.nomad

</code></pre>

<h3>
<a id="rolling-upgrades" class="anchor" href="#rolling-upgrades" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Rolling Upgrades</h3>

<p>Change up the jobs by running <code>jobs/hashiapp-v1-c3.nomad</code> or <code>jobs/hashiapp-v2-c3.nomad</code></p>

<p>or via your local machine:</p>

<pre><code>gcloud compute ssh ns-1 nomad run hashiconf-napa-2016/jobs/hashiapp-v2-c10.nomad
</code></pre>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/vynjo/hashiconf-napa-2016">Hashiconf-napa-2016</a> is maintained by <a href="https://github.com/vynjo">vynjo</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
